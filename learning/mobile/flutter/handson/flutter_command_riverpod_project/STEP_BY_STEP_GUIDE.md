# üöÄ Step-by-Step Guide: Command Pattern + Riverpod

## üìã M·ª•c ti√™u
Sau khi ho√†n th√†nh guide n√†y, b·∫°n s·∫Ω c√≥ m·ªôt Flutter app ho√†n ch·ªânh v·ªõi Command Pattern + Riverpod, c√≥ th·ªÉ:
- Load danh s√°ch users t·ª´ API
- T·∫°o user m·ªõi
- X√≥a user
- T·ª± ƒë·ªông handle loading states, errors

## üõ†Ô∏è Prerequisites
- Flutter SDK ƒë√£ c√†i ƒë·∫∑t
- VS Code ho·∫∑c Android Studio
- Hi·ªÉu bi·∫øt c∆° b·∫£n v·ªÅ Flutter widgets

---

## PHASE 1: PROJECT SETUP

### Step 1: T·∫°o Flutter Project
```bash
# Terminal/Command Prompt
flutter create my_command_app
cd my_command_app
```

### Step 2: Th√™m Dependencies
M·ªü `pubspec.yaml` v√† th√™m:
```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # State Management
  flutter_riverpod: ^2.4.9
  
  # HTTP Client  
  dio: ^5.4.0
  
  # UI Utilities
  flutter_screenutil: ^5.9.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.1
```

Ch·∫°y:
```bash
flutter pub get
```

### Step 3: T·∫°o C·∫•u tr√∫c Th∆∞ m·ª•c
```
lib/
‚îú‚îÄ‚îÄ main.dart
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ commands/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ command.dart
‚îÇ   ‚îú‚îÄ‚îÄ network/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dio_provider.dart
‚îÇ   ‚îî‚îÄ‚îÄ constants/
‚îÇ       ‚îî‚îÄ‚îÄ app_constants.dart
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ user.dart
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ user_service.dart
‚îî‚îÄ‚îÄ screens/
    ‚îî‚îÄ‚îÄ user_list_screen.dart
```

---

## PHASE 2: CORE INFRASTRUCTURE

### Step 4: T·∫°o Command Base Classes
**T·∫°o file:** `lib/core/commands/command.dart`
```dart
import 'package:flutter/foundation.dart';

// Base Command class - VI·∫æT 1 L·∫¶N, D√ôNG M√ÉI M√ÉI
abstract class Command<T> extends ChangeNotifier {
  bool _isExecuting = false;
  T? _data;
  String? _errorMessage;

  // Getters t·ª± ƒë·ªông
  bool get isExecuting => _isExecuting;
  bool get hasData => _data != null;
  bool get hasError => _errorMessage != null;
  T? get data => _data;
  String? get errorMessage => _errorMessage;

  // LOGIC CHUNG CHO T·∫§T C·∫¢ COMMANDS
  Future<void> execute() async {
    if (_isExecuting) return; // Auto prevent duplicate

    _isExecuting = true;
    _errorMessage = null;
    notifyListeners(); // UI t·ª± ƒë·ªông update

    try {
      _data = await performAction(); // G·ªçi business logic
    } catch (e) {
      _errorMessage = e.toString(); // Auto handle error
    } finally {
      _isExecuting = false;
      notifyListeners(); // UI t·ª± ƒë·ªông update
    }
  }

  // CH·ªà C·∫¶N IMPLEMENT METHOD N√ÄY CHO M·ªñI FEATURE
  Future<T> performAction();

  void clearResult() {
    _data = null;
    _errorMessage = null;
    notifyListeners();
  }
}

// Command v·ªõi 1 parameter
abstract class Command1<T, P> extends Command<T> {
  P? _parameter;

  Future<void> executeWith(P parameter) async {
    _parameter = parameter;
    await execute();
  }

  @override
  Future<T> performAction() {
    if (_parameter == null) {
      throw Exception('Parameter required for Command1');
    }
    return performActionWith(_parameter!);
  }

  // Implement n√†y thay v√¨ performAction()
  Future<T> performActionWith(P parameter);
}
```

### Step 5: T·∫°o App Constants
**T·∫°o file:** `lib/core/constants/app_constants.dart`
```dart
class AppConstants {
  static const String baseUrl = 'https://jsonplaceholder.typicode.com';
  static const String usersEndpoint = '/users';
}
```

### Step 6: Setup Dio Provider
**T·∫°o file:** `lib/core/network/dio_provider.dart`
```dart
import 'package:dio/dio.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../constants/app_constants.dart';

final dioProvider = Provider<Dio>((ref) {
  final dio = Dio();
  
  dio.options = BaseOptions(
    baseUrl: AppConstants.baseUrl,
    connectTimeout: const Duration(seconds: 10),
    receiveTimeout: const Duration(seconds: 10),
  );

  return dio;
});
```

---

## PHASE 3: DATA LAYER

### Step 7: T·∫°o User Model
**T·∫°o file:** `lib/models/user.dart`
```dart
class User {
  final String id;
  final String name;
  final String email;

  User({
    required this.id,
    required this.name,
    required this.email,
  });

  // Parse t·ª´ JSON (API response)
  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      id: json['id'].toString(),
      name: json['name'] ?? '',
      email: json['email'] ?? '',
    );
  }

  // Convert sang JSON (g·ª≠i l√™n API)
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'email': email,
    };
  }

  @override
  String toString() => 'User(id: $id, name: $name, email: $email)';
}
```

### Step 8: T·∫°o User Service
**T·∫°o file:** `lib/services/user_service.dart`
```dart
import 'package:dio/dio.dart';
import '../core/constants/app_constants.dart';
import '../models/user.dart';

class UserService {
  final Dio _dio;

  UserService(this._dio);

  // Load users t·ª´ API
  Future<List<User>> getUsers() async {
    final response = await _dio.get(AppConstants.usersEndpoint);
    
    if (response.statusCode == 200) {
      final List<dynamic> data = response.data;
      return data.map((json) => User.fromJson(json)).toList();
    } else {
      throw Exception('Failed to load users');
    }
  }

  // Create user m·ªõi
  Future<User> createUser(String name, String email) async {
    final response = await _dio.post(
      AppConstants.usersEndpoint,
      data: {
        'name': name,
        'email': email,
      },
    );

    if (response.statusCode == 201) {
      return User.fromJson(response.data);
    } else {
      throw Exception('Failed to create user');
    }
  }

  // Delete user
  Future<void> deleteUser(String id) async {
    final response = await _dio.delete('${AppConstants.usersEndpoint}/$id');
    
    if (response.statusCode != 200) {
      throw Exception('Failed to delete user');
    }
  }
}

// Riverpod Provider cho UserService
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../core/network/dio_provider.dart';

final userServiceProvider = Provider<UserService>((ref) {
  final dio = ref.read(dioProvider);
  return UserService(dio);
});
```

---

## PHASE 4: COMMAND IMPLEMENTATIONS

### Step 9: T·∫°o User Commands
**T·∫°o file:** `lib/commands/user_commands.dart`
```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../core/commands/command.dart';
import '../models/user.dart';
import '../services/user_service.dart';

// Load Users Command - CH·ªà 4 LINES!
class LoadUsersCommand extends Command<List<User>> {
  final UserService userService;

  LoadUsersCommand(this.userService);

  @override
  Future<List<User>> performAction() async {
    return await userService.getUsers();
  }
}

// Create User Command - CH·ªà 4 LINES!
class CreateUserCommand extends Command1<User, Map<String, String>> {
  final UserService userService;

  CreateUserCommand(this.userService);

  @override
  Future<User> performActionWith(Map<String, String> userData) async {
    return await userService.createUser(
      userData['name']!,
      userData['email']!,
    );
  }
}

// Delete User Command - CH·ªà 4 LINES!
class DeleteUserCommand extends Command1<void, String> {
  final UserService userService;

  DeleteUserCommand(this.userService);

  @override
  Future<void> performActionWith(String userId) async {
    return await userService.deleteUser(userId);
  }
}

// Providers cho Commands
final loadUsersCommandProvider = Provider<LoadUsersCommand>((ref) {
  final userService = ref.read(userServiceProvider);
  return LoadUsersCommand(userService);
});

final createUserCommandProvider = Provider<CreateUserCommand>((ref) {
  final userService = ref.read(userServiceProvider);
  return CreateUserCommand(userService);
});

final deleteUserCommandProvider = Provider<DeleteUserCommand>((ref) {
  final userService = ref.read(userServiceProvider);
  return DeleteUserCommand(userService);
});
```

---

## PHASE 5: UI IMPLEMENTATION

### Step 10: T·∫°o User List Screen
**T·∫°o file:** `lib/screens/user_list_screen.dart`
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../commands/user_commands.dart';
import '../models/user.dart';

class UserListScreen extends ConsumerStatefulWidget {
  @override
  ConsumerState<UserListScreen> createState() => _UserListScreenState();
}

class _UserListScreenState extends ConsumerState<UserListScreen> {
  late final LoadUsersCommand _loadUsersCommand;
  late final CreateUserCommand _createUserCommand;
  late final DeleteUserCommand _deleteUserCommand;

  @override
  void initState() {
    super.initState();
    
    // L·∫•y commands t·ª´ providers
    _loadUsersCommand = ref.read(loadUsersCommandProvider);
    _createUserCommand = ref.read(createUserCommandProvider);
    _deleteUserCommand = ref.read(deleteUserCommandProvider);
    
    // Setup listeners
    _loadUsersCommand.addListener(_handleLoadResult);
    _createUserCommand.addListener(_handleCreateResult);
    _deleteUserCommand.addListener(_handleDeleteResult);
    
    // Load users ngay khi v√†o screen
    _loadUsersCommand.execute();
  }

  @override
  void dispose() {
    _loadUsersCommand.removeListener(_handleLoadResult);
    _createUserCommand.removeListener(_handleCreateResult);
    _deleteUserCommand.removeListener(_handleDeleteResult);
    super.dispose();
  }

  // Handle k·∫øt qu·∫£ load users
  void _handleLoadResult() {
    if (_loadUsersCommand.hasError) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: ${_loadUsersCommand.errorMessage}'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Handle k·∫øt qu·∫£ create user
  void _handleCreateResult() {
    if (_createUserCommand.hasData) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('User created successfully!')),
      );
      _loadUsersCommand.execute(); // Refresh danh s√°ch
    } else if (_createUserCommand.hasError) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: ${_createUserCommand.errorMessage}'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Handle k·∫øt qu·∫£ delete user
  void _handleDeleteResult() {
    if (_deleteUserCommand.hasData) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('User deleted successfully!')),
      );
      _loadUsersCommand.execute(); // Refresh danh s√°ch
    } else if (_deleteUserCommand.hasError) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: ${_deleteUserCommand.errorMessage}'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Users'),
        actions: [
          IconButton(
            icon: Icon(Icons.refresh),
            onPressed: () => _loadUsersCommand.execute(),
          ),
        ],
      ),
      body: _buildBody(),
      floatingActionButton: FloatingActionButton(
        onPressed: _showCreateUserDialog,
        child: Icon(Icons.add),
      ),
    );
  }

  Widget _buildBody() {
    // S·ª¨ D·ª§NG LISTENABLEBUILDER ƒê·ªÇ AUTO-REBUILD
    return ListenableBuilder(
      listenable: _loadUsersCommand,
      builder: (context, child) {
        // Loading state
        if (_loadUsersCommand.isExecuting) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                CircularProgressIndicator(),
                SizedBox(height: 16),
                Text('Loading users...'),
              ],
            ),
          );
        }

        // Error state
        if (_loadUsersCommand.hasError && !_loadUsersCommand.hasData) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.error, size: 64, color: Colors.red),
                SizedBox(height: 16),
                Text('Error: ${_loadUsersCommand.errorMessage}'),
                SizedBox(height: 16),
                ElevatedButton(
                  onPressed: () => _loadUsersCommand.execute(),
                  child: Text('Retry'),
                ),
              ],
            ),
          );
        }

        // Empty state
        if (!_loadUsersCommand.hasData || _loadUsersCommand.data!.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.people_outline, size: 64, color: Colors.grey),
                SizedBox(height: 16),
                Text('No users found'),
                SizedBox(height: 16),
                ElevatedButton(
                  onPressed: _showCreateUserDialog,
                  child: Text('Create User'),
                ),
              ],
            ),
          );
        }

        // Success state - hi·ªÉn th·ªã danh s√°ch users
        return ListView.builder(
          itemCount: _loadUsersCommand.data!.length,
          itemBuilder: (context, index) {
            final user = _loadUsersCommand.data![index];
            return Card(
              margin: EdgeInsets.all(8),
              child: ListTile(
                leading: CircleAvatar(
                  child: Text(user.name[0].toUpperCase()),
                ),
                title: Text(user.name),
                subtitle: Text(user.email),
                trailing: IconButton(
                  icon: Icon(Icons.delete, color: Colors.red),
                  onPressed: () => _confirmDelete(user),
                ),
              ),
            );
          },
        );
      },
    );
  }

  void _showCreateUserDialog() {
    final nameController = TextEditingController();
    final emailController = TextEditingController();

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Create User'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: nameController,
              decoration: InputDecoration(labelText: 'Name'),
            ),
            TextField(
              controller: emailController,
              decoration: InputDecoration(labelText: 'Email'),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // Execute create command
              _createUserCommand.executeWith({
                'name': nameController.text,
                'email': emailController.text,
              });
            },
            child: Text('Create'),
          ),
        ],
      ),
    );
  }

  void _confirmDelete(User user) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Delete User'),
        content: Text('Are you sure you want to delete ${user.name}?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // Execute delete command
              _deleteUserCommand.executeWith(user.id);
            },
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: Text('Delete'),
          ),
        ],
      ),
    );
  }
}
```

### Step 11: Update Main App
**Update file:** `lib/main.dart`
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'screens/user_list_screen.dart';

void main() {
  runApp(
    ProviderScope( // Wrap v·ªõi ProviderScope cho Riverpod
      child: MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Command Pattern Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        useMaterial3: true,
      ),
      home: UserListScreen(),
      debugShowCheckedModeBanner: false,
    );
  }
}
```

---

## PHASE 6: TESTING & RUNNING

### Step 12: Test App
```bash
flutter run
```

**Expected behavior:**
1. App loads v√† fetch users t·ª´ API
2. Hi·ªÉn th·ªã loading spinner
3. Hi·ªÉn th·ªã danh s√°ch users
4. C√≥ th·ªÉ t·∫°o user m·ªõi
5. C√≥ th·ªÉ x√≥a user
6. Error handling t·ª± ƒë·ªông

### Step 13: Debug Common Issues

**Issue 1:** `Target of URI doesn't exist`
- **Fix:** Ch·∫°y `flutter pub get`

**Issue 2:** Network error
- **Fix:** Test tr√™n real device ho·∫∑c enable internet trong emulator

**Issue 3:** Commands kh√¥ng ho·∫°t ƒë·ªông
- **Fix:** Ki·ªÉm tra providers ƒë√£ setup ƒë√∫ng ch∆∞a

---

## üéØ PHASE 7: ADDING NEW FEATURES

### Step 14: Th√™m Search Feature (V√≠ d·ª• m·ªü r·ªông)

**Th√™m v√†o UserService:**
```dart
Future<List<User>> searchUsers(String query) async {
  final users = await getUsers();
  return users.where((user) => 
    user.name.toLowerCase().contains(query.toLowerCase()) ||
    user.email.toLowerCase().contains(query.toLowerCase())
  ).toList();
}
```

**T·∫°o Search Command:**
```dart
class SearchUsersCommand extends Command1<List<User>, String> {
  final UserService userService;

  SearchUsersCommand(this.userService);

  @override
  Future<List<User>> performActionWith(String query) async {
    return await userService.searchUsers(query);
  }
}
```

**Th√™m Search UI:**
```dart
// Trong UserListScreen, th√™m search bar
TextField(
  decoration: InputDecoration(hintText: 'Search users...'),
  onChanged: (query) => _searchUsersCommand.executeWith(query),
)
```

---

## ‚úÖ CHECKLIST HO√ÄN TH√ÄNH

- [ ] ‚úÖ Project setup v·ªõi dependencies
- [ ] ‚úÖ Command base classes
- [ ] ‚úÖ User model & service
- [ ] ‚úÖ User commands implementation
- [ ] ‚úÖ UI screen v·ªõi ListenableBuilder
- [ ] ‚úÖ Error handling t·ª± ƒë·ªông
- [ ] ‚úÖ Loading states t·ª± ƒë·ªông
- [ ] ‚úÖ App ch·∫°y th√†nh c√¥ng

---

## üöÄ NEXT STEPS

Sau khi ho√†n th√†nh guide n√†y, b·∫°n c√≥ th·ªÉ:

1. **Th√™m features m·ªõi** - Ch·ªâ c·∫ßn t·∫°o Command m·ªõi
2. **Improve UI** - Th√™m animations, better design
3. **Add offline support** - Cache data locally
4. **Add testing** - Unit tests cho Commands
5. **Add more complex workflows** - Multi-step operations

## üéØ KEY TAKEAWAYS

1. **Command Pattern** gi√∫p t√°ch bi·ªát UI v√† business logic
2. **Setup 1 l·∫ßn, benefit m√£i m√£i** 
3. **Consistent behavior** across to√†n b·ªô app
4. **Easy to test** v√† maintain
5. **Scalable** cho large applications

**üéâ Congratulations! B·∫°n ƒë√£ implement th√†nh c√¥ng Command Pattern + Riverpod!** 